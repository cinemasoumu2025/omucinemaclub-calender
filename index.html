<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
body{
  font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
  background:#ffffff;
  color:#1b1b1b;
}

/* å…±é€š */
.cookie{
  background:#ffffff;
  border-radius:32px;
  padding:20px;
  margin:15px;
  border:1px solid #e9e4d6;
  box-shadow:
    0 6px 14px rgba(0,0,0,.06),
    inset 0 3px 5px rgba(255,255,255,.7);
}

h3{ margin-top:0 }

.app-title{
  background:#ffffff;
  border-radius: 22px;
  padding: 12px 22px;
  display:block;
  border:1px solid #e9e4d6;
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
  font-weight:800;
  letter-spacing:0.04em;
  font-size: 24px;
  color:#1b1b1b;

  /* ä¸­å¤®å¯„ã› */
  margin: 18px auto;
  text-align: center;
}

#time{
  font-size: 1.6em;   /* ãŠå¥½ã¿ã§ 1.4ã€œ2.0em */
  font-weight: bold;
  margin-left: 6px;
  display: inline-block;
}
.controls{
  margin-top: 10px;
}

.controls label{
  font-size: 1.1em;      /* æ–‡å­—ã‚µã‚¤ã‚º */
  margin-right: 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.controls input[type="checkbox"]{
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.reload-btn{
  width: 100%;
  margin-top: 10px;
  padding: 12px;

  font-size: 17px;
  font-weight: 700;

  border-radius: 20px;
  border: 1px solid #d8c08a;

  background: linear-gradient(
    to bottom,
    #cfa24a,
    #b57a00
  );

  color: #ffffff;
  cursor: pointer;

  box-shadow:
    0 4px 10px rgba(0,0,0,.12),
    inset 0 2px 4px rgba(255,255,255,.35);

  transition:
    background .2s ease,
    box-shadow .2s ease,
    transform .1s ease;
}

.reload-btn:hover{
  background: linear-gradient(
    to bottom,
    #ddb45c,
    #c98a0a
  );
  box-shadow:
    0 6px 14px rgba(0,0,0,.18),
    inset 0 2px 4px rgba(255,255,255,.45);
}

.reload-btn:active{
  transform: translateY(1px);
  box-shadow:
    0 3px 6px rgba(0,0,0,.18),
    inset 0 2px 4px rgba(255,255,255,.25);
}





/* ä»Šæ—¥ãƒ»1é€±é–“ã®äºˆå®šã®æ—¥ä»˜ã‚’å¤§ãã */
.cookie > strong{
  display: inline-block;
  font-size: 1.25em;   /* â† ã“ã“ã§èª¿æ•´ï¼ˆ1.2ã€œ1.4ãã‚‰ã„ãŒãŠã™ã™ã‚ï¼‰ */
  margin: 6px 0 8px;
}


/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
.scroll{
  overflow:hidden;
  white-space:nowrap;
}
.scroll span{
  display:inline-block;
  padding-left:100%;
  animation-name:scroll;
  animation-timing-function:linear;
  animation-iteration-count:1;
  font-size: 20px;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}

.blink{
  animation-name:scroll, blink;
}
@keyframes blink{50%{opacity:0}}

.controls label{
  margin-right:10px;
  font-size:0.9em;
}

/* ===== ã“ã“ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…±é€šæ  ===== */
.calendar-card{
  margin: 10px 15px;
  border: 2px solid #d8c08a;
  border-radius: 28px;
  padding: 10px;
  background: #ffffff;
  box-shadow: 0 8px 18px rgba(0,0,0,.06);
}

/* ã‚¿ãƒ– */
.tabs{
  display:flex;
  justify-content:space-around;
  margin: 10px;
}
.tabs button{
  width: 23%;
  padding: 10px;
  border:none;
  border-radius: 20px;
  font-size: 18px;
  cursor:pointer;
  background:#ffffff;
  color:#333;
  border:1px solid #e9e4d6;
  transition: transform .1s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}

/* é¸æŠä¸­ã‚¿ãƒ–ã®è‰²ã‚’å’Œãƒ¢ãƒ€ãƒ³ã«å¤‰æ›´ */
.tabs button.tab-active{
  background:#1b1b1b;
  color:#fff;
  box-shadow: 0 6px 14px rgba(0,0,0,.15);
}
.tabs button.tab-inactive{
  background:#ffffff;
}

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
.calendar-nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.calendar-nav button{
  border:none;
  background:#1b1b1b;
  color:#fff;
  border-radius:16px;
  padding:4px 12px;
  font-size:18px;
  cursor:pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,.12);
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  text-align:center;
  font-size:12px;
}
.day-name{
  font-weight:bold;
  color:#444;
}
.today-label{
  display:block;
  font-size:10px;
  margin-top:4px;
  color:#b57a00;
  font-weight:bold;
}
.cal-cell{
  background:#fff;
  border-radius:16px;
  padding:8px 4px;
  box-shadow:0 3px 0 rgba(0,0,0,0.05);
  cursor:pointer;
  border:1px solid #f0f0f0;
}
.cal-sun{
  background:#fff4f4;
}
.cal-sat{
  background:#f4f7ff;
}
/* ä»Šæ—¥ã‚»ãƒ«ã®ç‚¹æ»… */
@keyframes blinkToday {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}
.cal-today{
  background: #fff;
  border: 2px solid #b57a00;
  animation: blinkToday 1.2s infinite;
}

/* è¨˜å·èª¬æ˜ */
.legend{
  margin-top:10px;
  font-size:12px;
  color:#555;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ ===== */
.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);

  display: none;
  justify-content: center;
  align-items: center;

  z-index: 9999;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ  ===== */
.modal-content{
  background: #ffffff;
  border-radius: 28px;
  padding: 20px;
  width: 90%;
  max-width: 420px;

  max-height: 85vh;
  display: flex;
  flex-direction: column;

  box-shadow: 0 6px 15px rgba(0,0,0,.25);
}

/* ===== æ—¥ä»˜ ===== */
.modal-date{
  font-weight: bold;
  font-size: 1.1em;
  margin-bottom: 10px;
  flex-shrink: 0;
}

/* ===== æœ¬æ–‡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼‰ ===== */
.modal-body{
  flex: 1;
  overflow-y: auto;
  margin: 10px 0 16px;
  -webkit-overflow-scrolling: touch;
}

/* æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ */
.modal-status{
  white-space: pre-wrap;
  line-height: 1.6;
  color:#333;
}

/* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š ===== */
.modal-section {
  margin: 6px 0;
  line-height: 1.4;
}

.modal-section strong{
  display: block;
  margin-bottom: 6px;
  color:#111;
}

.modal-divider{
  border-top: 1px dashed #d8c08a;
  margin: 14px 0;
}
.modal-controls{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
}
.modal-controls button{
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}

/* ===== æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆä¸‹å›ºå®šï¼‰ ===== */
.modal-back{
  width: 100%;
  padding: 12px;
  border: none;
  background: #1b1b1b;
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  border-radius: 20px;
  cursor: pointer;

  flex-shrink: 0;

  box-shadow:
    0 6px 10px rgba(0,0,0,.15),
    inset 0 3px 5px rgba(255,255,255,.35);
  transition: transform .1s ease, box-shadow .2s ease;
}

.modal-back:hover{
  transform: translateY(-2px);
  box-shadow:
    0 8px 14px rgba(0,0,0,.2),
    inset 0 3px 5px rgba(255,255,255,.45);
}

.modal-back:active{
  transform: translateY(0);
}

/* ===== éƒ¨æ´»ç”¨ ===== */
.club-title {
  font-weight: bold;
  margin-top: 8px;
}

.club-detail {
  margin: 8px 0;
  padding: 10px;
  border-radius: 18px;
  background: #f7f7f7;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.club-divider {
  margin: 6px 0;
  color: #999;
}

.paging-area{
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 10px;
}

.paging-row{
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

.paging-left{
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  overflow: hidden;
}

.paging-right{
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.paging-left span,
.paging-left select{
  font-size: 12px;
}

.paging-sep{
  opacity: 0.6;
}

.paging-btn {
  padding: 8px 12px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  transition: transform .1s ease, background .2s ease;
  background:#1b1b1b;
  color:#fff;
}
.paging-btn:hover {
  transform: translateY(-1px);
}
.paging-btn[disabled] {
  opacity: 0.4;
  cursor: not-allowed;
  box-shadow: none;
}

.club-card{
  background: #ffffff;
  border: 2px solid #d8c08a;
  border-radius: 20px;
  padding: 12px;
  margin: 8px 0;
  box-shadow:
    0 6px 10px rgba(0,0,0,.12),
    inset 0 3px 5px rgba(255,255,255,.4);
}

.club-card-title{
  font-weight: bold;
  margin-bottom: 8px;
}

.club-card-body{
  white-space: pre-wrap;
  line-height: 1.5;
  font-size: 14px;
}
/*ãƒœã‚¿ãƒ³è‰²åˆ¶å¾¡*/
button[disabled]{
  background: #cccccc !important;
  cursor: not-allowed;
}


/* ä¸‹éƒ¨ãƒªãƒ³ã‚¯ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç›´ä¸‹è¡¨ç¤ºï¼‰ */
.link-area{
  display:none;
  grid-template-columns: repeat(3, 1fr); /* â† 3åˆ—å›ºå®š */
  margin: 12px 15px 0;
  padding: 10px 0;
  display:flex;
  gap: 10px;
  justify-content:center;
}

.link-area button{
  flex: 1 1 120px;
  border:none;
  border-radius: 18px;
  padding: 10px 14px;
  background: #1b1b1b;
  color:#fff;
  font-weight: 800;
  cursor:pointer;
  box-shadow: 0 6px 12px rgba(0,0,0,0.12);
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 600px){
  body{ font-size: 12px; }
  .cookie{
    padding: 16px;
    margin: 12px;
    border-radius: 26px;
  }
  .cookie h3{
    font-size: 1.05em;
  }
  .scroll span{
    font-size: 16px;
  }
  .tabs button{
    font-size: 16px;
    padding: 8px;
  }
  .calendar-nav button{
    font-size: 16px;
    padding: 4px 10px;
  }
  .calendar-grid{
    font-size: 11px;
    gap: 5px;
  }
  .cal-cell{
    padding: 6px 3px;
    border-radius: 14px;
  }
  .today-label{
    font-size: 9px;
  }
  .legend{
    font-size: 11px;
  }
  .modal-content{
    padding: 16px;
    width: 94%;
    max-width: 360px;
  }
  .modal-date{
    font-size: 1.0em;
  }
  .modal-status{
    font-size: 13px;
    line-height: 1.55;
  }
  .modal-back{
    font-size: 15px;
    padding: 11px;
  }
  .club-card-body{
    font-size: 13px;
  }
}

/* iPad mini ç¸¦ï¼ˆ600pxã€œ768pxï¼‰ */
@media (min-width: 601px) and (max-width: 768px) and (orientation: portrait){
  body{ font-size: 13px; }
  .cookie{
    padding: 18px;
    margin: 14px;
    border-radius: 28px;
  }
  .cookie h3{
    font-size: 1.15em;
  }
  .scroll span{
    font-size: 18px;
  }
  .tabs button{
    font-size: 17px;
    padding: 9px;
  }
  .calendar-nav button{
    font-size: 17px;
    padding: 4px 11px;
  }
  .calendar-grid{
    font-size: 12px;
    gap: 6px;
  }
  .cal-cell{
    padding: 7px 4px;
    border-radius: 15px;
  }
  .today-label{
    font-size: 9.5px;
  }
  .legend{
    font-size: 12px;
  }
  .modal-content{
    padding: 18px;
    width: 92%;
    max-width: 380px;
  }
  .modal-date{
    font-size: 1.05em;
  }
  .modal-status{
    font-size: 13.5px;
    line-height: 1.6;
  }
  .modal-back{
    font-size: 15px;
    padding: 11px;
  }
  .club-card-body{
    font-size: 13.5px;
  }
}

/* iPad æ¨ªï¼ˆ600pxã€œ768pxï¼‰ */
@media (min-width: 601px) and (max-width: 768px) and (orientation: landscape){
  body{ font-size: 13.5px; }
  .cookie{
    padding: 20px;
    margin: 14px;
    border-radius: 28px;
  }
  .cookie h3{
    font-size: 1.2em;
  }
  .scroll span{
    font-size: 20px;
  }
  .tabs button{
    font-size: 18px;
    padding: 10px;
  }
  .calendar-nav button{
    font-size: 18px;
    padding: 5px 12px;
  }
  .calendar-grid{
    font-size: 12.5px;
    gap: 6px;
  }
  .cal-cell{
    padding: 8px 4px;
    border-radius: 16px;
  }
  .today-label{
    font-size: 10px;
  }
  .legend{
    font-size: 12.5px;
  }
  .modal-content{
    padding: 20px;
    width: 86%;
    max-width: 420px;
  }
  .modal-date{
    font-size: 1.1em;
  }
  .modal-status{
    font-size: 14px;
    line-height: 1.6;
  }
  .modal-back{
    font-size: 16px;
    padding: 12px;
  }
  .club-card-body{
    font-size: 14px;
  }
}

/* PCï¼ˆ12~14inchï¼‰ */
@media (min-width: 769px) and (max-width: 1279px){
  body{ font-size: 14px; }
  .cookie{
    padding: 20px;
    margin: 16px;
    border-radius: 30px;
  }
  .cookie h3{
    font-size: 1.3em;
  }
  .scroll span{
    font-size: 22px;
  }
  .tabs button{
    font-size: 18px;
    padding: 10px;
  }
  .calendar-nav button{
    font-size: 18px;
    padding: 5px 12px;
  }
  .calendar-grid{
    font-size: 13px;
    gap: 7px;
  }
  .cal-cell{
    padding: 9px 5px;
    border-radius: 17px;
  }
  .today-label{
    font-size: 10px;
  }
  .legend{
    font-size: 13px;
  }
  .modal-content{
    padding: 22px;
    width: 70%;
    max-width: 520px;
  }
  .modal-date{
    font-size: 1.2em;
  }
  .modal-status{
    font-size: 15px;
    line-height: 1.7;
  }
  .modal-back{
    font-size: 16px;
    padding: 12px;
  }
  .club-card-body{
    font-size: 14px;
  }
}

/* PCï¼ˆ15inchä»¥ä¸Šï¼‰ */
@media (min-width: 1280px){
  body{ font-size: 15px; }
  .cookie{
    padding: 22px;
    margin: 18px;
    border-radius: 32px;
  }
  .cookie h3{
    font-size: 1.4em;
  }
  .scroll span{
    font-size: 24px;
  }
  .tabs button{
    font-size: 19px;
    padding: 11px;
  }
  .calendar-nav button{
    font-size: 19px;
    padding: 6px 14px;
  }
  .calendar-grid{
    font-size: 14px;
    gap: 8px;
  }
  .cal-cell{
    padding: 10px 6px;
    border-radius: 18px;
  }
  .today-label{
    font-size: 11px;
  }
  .legend{
    font-size: 14px;
  }
  .modal-content{
    padding: 24px;
    width: 60%;
    max-width: 640px;
  }
  .modal-date{
    font-size: 1.25em;
  }
  .modal-status{
    font-size: 16px;
    line-height: 1.8;
  }
  .modal-back{
    font-size: 17px;
    padding: 13px;
  }
  .club-card-body{
    font-size: 15px;
  }
}


</style>
</head>

<body>

<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
<h1 class="app-title">ã‚·ãƒãƒã‚¯ãƒ©ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>

<!-- æ™‚åˆ» & è¡¨ç¤ºåˆ‡æ›¿ -->
<div class="cookie">
  <strong>ãŸã ã„ã¾ã®æ™‚åˆ»</strong>
  <span id="time"></span>
  
  <div>
  ç¾åœ¨ã®éƒ¨å®¤äººæ•°ï¼š
  <strong><span id="roomCount">0</span>äºº</strong>
  </div>

  <div class="controls">
    <label><input type="checkbox" checked data-key="uni">å¤§å­¦å…±é€š</label>
    <label><input type="checkbox" checked data-key="naka">ä¸­ç™¾èˆŒé³¥C</label>
    <label><input type="checkbox" checked data-key="sug">æ‰æœ¬C</label>
    <label><input type="checkbox" checked data-key="mori">æ£®ä¹‹å®®C</label>
    <label><input type="checkbox" checked data-key="club">éƒ¨æ´»</label>
  </div>
  <button class="reload-btn" onclick="load(true)">
  ğŸ”„ å†èª­ã¿è¾¼ã¿ã€€æœ€æ–°æƒ…å ±ã«æ›´æ–°
  </button>

</div>

<div id="today"></div>
<div id="week"></div>

<!-- ===== ã‚¿ãƒ–ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä¸€ä½“åŒ–ã—ãŸæ  ===== -->
<div class="calendar-card">

  <!-- ã‚¿ãƒ– -->
  <div class="tabs">
    <button id="tabUni" class="tab-inactive" onclick="showTab('uni')">å¤§å­¦å…¨ä½“</button>
    <button id="tabNaka" class="tab-active" onclick="showTab('naka')">ä¸­ç™¾èˆŒé³¥C</button>
    <button id="tabMori" class="tab-inactive" onclick="showTab('mori')">æ£®ä¹‹å®®C</button>
    <button id="tabClub" class="tab-inactive" onclick="showTab('club')">éƒ¨æ´»å‹•</button>
  </div>

  <!-- ä¸­ç™¾èˆŒé³¥å­¦äº‹æ—¥ç¨‹ -->
  <div id="nakaArea">
    <div id="calendar"></div>
  </div>

  <!-- å¤§å­¦å­¦äº‹æ—¥ç¨‹ -->
  <div id="uniArea" style="display:none">
    <div id="uniCalendar"></div>
  </div>

  <!-- æ£®ä¹‹å®®å­¦äº‹æ—¥ç¨‹ -->
  <div id="moriArea" style="display:none">
    <div id="moriCalendar"></div>
  </div>

  <!-- éƒ¨æ´»å‹•æ—¥ç¨‹ -->
  <div id="clubArea" style="display:none">
    <div id="clubCalendar"></div>
  </div>

</div>
<!-- ===== ã“ã“ã¾ã§ä¸€ä½“åŒ–æ  ===== -->

<div class="cookie">
  <button id="enterBtn" class="reload-btn" onclick="enterRoom()"> éƒ¨å®¤ã«å…¥å®¤ã™ã‚‹</button>
  <button id="exitBtn" class="reload-btn" onclick="exitRoom()" disabled> éƒ¨å®¤ã‹ã‚‰é€€å®¤ã™ã‚‹</button>
</div>


<!-- ãƒªãƒ³ã‚¯ã‚¨ãƒªã‚¢ -->
<div id="linkArea" class="link-area" ></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div id="modalDate" class="modal-date"></div>

    <div class="modal-body">
      <div id="modalStatus" class="modal-status"></div>
    </div>

    <button class="modal-back" onclick="closeModal()">
      ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹
    </button>
  </div>
</div>


<script>
let allData=[];
let calendarData=[];
let scheduleData = [];
let clubCalData = [];
let clubData = [];
let weekIndex=0;
let weekTimer=null;

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¥ã‚ªãƒ•ã‚»ãƒƒãƒˆ
let nakaOffset = 0;
let uniOffset = 0;
let moriOffset = 0;
let clubOffset = 0;


 //===== ID =====
 // â˜… è¿½åŠ ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
  const VISIT_KEY = "club_visit_id";

  function getVisitId(){
  let id = localStorage.getItem(VISIT_KEY);
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem(VISIT_KEY, id);
  }
  return id;
  }

 const visitId = getVisitId();
 const PAGE_NAME = "index";

/* ================================
   GAS / GitHub ä¸¡å¯¾å¿œãƒ©ãƒƒãƒ‘ãƒ¼
================================ */

const isGAS = typeof google !== "undefined"
           && google.script
           && google.script.run;

/**
 * GASãªã‚‰ google.script.run
 * GitHubãªã‚‰ mock é–¢æ•°
 */
function runGAS(method, ...args){
  if(isGAS){
    return new Promise((resolve, reject)=>{
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)[method](...args);
    });
  }else{
    // GitHub Pages
    const paramMap = {
      getScheduleData: {},
      getCalendarData: {},
      getButtonData: { target: args[0], active: args[1] },
      getRoomStatus: { visitId: args[0] },
      enterRoom: { visitId: args[0] },
      exitRoom: { visitId: args[0] },
      recordViewer: { page: args[0], visitId: args[1] }
    };
    return fetchAPI(method, paramMap[method] || {});
  }
}

const GAS_API = "https://script.google.com/macros/s/AKfycbz-hHL28w2EL_xpDsja9AAA2IdHHMS8ENT6JiBo8by3jM6VPMHVo7xN0CoWKF3trAaj/exec";

function fetchAPI(action, params = {}){
  const url = new URL(GAS_API);
  url.searchParams.set("action", action);

  Object.entries(params).forEach(([k,v])=>{
    url.searchParams.set(k, v);
  });

  return fetch(url.toString())
    .then(res => res.json());
}



// ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã‚‰è¨˜éŒ²
runGAS("recordViewer", PAGE_NAME, visitId);


// æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰è‡ªå‹•ã§å†èª­ã¿è¾¼ã¿
function scheduleMidnightReload() {
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
  const diff = next.getTime() - now.getTime();

  setTimeout(() => {
    load(true);
    scheduleMidnightReload();
  }, diff);
}

/* ===== æ™‚åˆ» ===== */
function updateTime(){
  time.textContent=new Date().toLocaleString();
}
setInterval(updateTime,1000);
updateTime();

/* ===== ãƒ‡ãƒ¼ã‚¿èª­è¾¼ ===== */
function load(force=false){

  runGAS("getScheduleData").then(d=>{
  scheduleData = d.schedule;
  clubData     = d.club;
  allData      = d.schedule;
  render();
  }).catch(()=>{
  document.body.innerHTML="ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒã§ãã¾ã›ã‚“";
  });

  runGAS("getCalendarData").then(d=>{
  calendarData = d.scheduleCal;
  clubCalData  = d.clubCal;
  renderNakaCalendar();
  renderUniCalendar();
  renderMoriCalendar();
  renderClubCalendar();
  return runGAS("getButtonData", "A", true);
  }).then(renderLinks).catch(()=>{
  document.body.innerHTML="ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒã§ãã¾ã›ã‚“";
  });

}


// ãƒªãƒ³ã‚¯è¡¨ç¤º
const linkArea = document.getElementById("linkArea");
function renderLinks(buttons){
  const list = (buttons || [])
    .filter(item => item.name && item.url && item.target)
    .filter(item => String(item.target || "").trim().toUpperCase().includes("A"));

  if(!list.length){
    linkArea.style.display = "none";
    return;
  }

  linkArea.style.display = "flex";
  linkArea.innerHTML = list.map(b =>
    `<button onclick="window.open('${b.url}', '_blank', 'noopener,noreferrer')">${b.name}</button>`
  ).join("");
}





/* ===== è¡¨ç¤ºON/OFF ===== */
function enabled(key){
  return document.querySelector(`input[data-key="${key}"]`).checked;
}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ===== */
function scrollSpan(text, duration, blink){
  const cls = blink ? "blink" : "";
  return `
    <div class="scroll">
      <span class="${cls}" style="animation-duration:${duration}s">
        ${text}
      </span>
    </div>
  `;
}

/* ===== ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ ===== */
function buildText(d){
  let t=[];

  if(enabled("uni")) t.push(`å¤§å­¦å…±é€šï¼š${d.uni}`);
  if(enabled("naka")) t.push(`ä¸­ç™¾èˆŒé³¥Cï¼š${d.naka}`);
  if(enabled("sug")) t.push(`æ‰æœ¬Cï¼š${d.sug}`);
  if(enabled("mori")) t.push(`æ£®ä¹‹å®®Cï¼š${d.mori}`);

  if(enabled("club")){
    if(!d.clubList || d.clubList.length === 0){
      t.push("ã‚·ãƒãƒã‚¯ãƒ©ãƒ–ã®æ´»å‹•äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“");
    } else {
      d.clubList.forEach((item, idx) => {
        if(!item.content) return;
        t.push(
          `æ´»å‹•${idx+1}ï¼š${item.content}` +
          (item.time ? ` / ${item.time}` : "") +
          (item.place ? ` / ${item.place}` : "") +
          (item.need ? ` / ${item.need}` : "") +
          (item.note ? ` / ${item.note}` : "")
        );
      });
    }
  }
  return t.join(" ï¼ ");
}

/* ===== ä»Šæ—¥ & 1é€±é–“ ===== */
function render(){
  if(!allData || !allData.length) return;
  renderToday();
  renderWeek();
}
function renderToday(){
  const todayStr = new Date().toDateString();
  const todayData = allData.find(d =>
    new Date(d.dateISO).toDateString() === todayStr
  ) || allData[0];

  const text = buildText(todayData) || "";
  const durationSec = Math.max(10, Math.min(30, Math.ceil(text.length / 4)));

  today.innerHTML = `
    <div class="cookie">
      <h3>ä»Šæ—¥ã®äºˆå®š</h3>
      <strong>${todayData.month}/${todayData.day}ï¼ˆ${todayData.week}ï¼‰</strong>
      ${scrollSpan(text, durationSec, (todayData.uni||"").includes("è©¦é¨“") || (todayData.naka||"").includes("è©¦é¨“")||(todayData.uni||"").includes("ãƒ†ã‚¹ãƒˆ") || (todayData.naka||"").includes("å…±ãƒ†"))}
    </div>
  `;
  
  const span = today.querySelector(".scroll span");
  span.style.animationIterationCount = "infinite";
}

function renderWeek(){
  if(!allData || !allData.length) return;
  weekIndex = weekIndex % allData.length;

  if(weekTimer) clearTimeout(weekTimer);

  const d = allData[weekIndex];
  const text = buildText(d);

  week.innerHTML = `
    <div class="cookie">
      <h3>1é€±é–“ã®äºˆå®š</h3>
      <strong>${d.month}/${d.day}ï¼ˆ${d.week}ï¼‰</strong>
      ${scrollSpan(text, 1, d.uni.includes("è©¦é¨“") || d.naka.includes("è©¦é¨“")||d.uni.includes("ãƒ†ã‚¹ãƒˆ") || d.naka.includes("å…±ãƒ†"))}
    </div>
  `;

  const span = week.querySelector(".scroll span");
  const speed = 100;
  const distance = span.scrollWidth + week.querySelector(".scroll").clientWidth;
  const durationSec = Math.max(6, distance / speed);

  span.style.animationDuration = durationSec + "s";
  span.style.animationIterationCount = "1";

  span.addEventListener("animationend", () => {
    weekTimer = setTimeout(() => {
      weekIndex = (weekIndex + 1) % allData.length;
      renderWeek();
    }, 1000);
  }, { once: true });
}

/* ===== ã‚¿ãƒ–åˆ‡æ›¿ ===== */
function showTab(tab){
  document.getElementById("uniArea").style.display  = (tab === 'uni') ? 'block' : 'none';
  document.getElementById("nakaArea").style.display = (tab === 'naka') ? 'block' : 'none';
  document.getElementById("moriArea").style.display = (tab === 'mori') ? 'block' : 'none';
  document.getElementById("clubArea").style.display = (tab === 'club') ? 'block' : 'none';

  document.getElementById("tabUni").className  = (tab === 'uni') ? 'tab-active' : 'tab-inactive';
  document.getElementById("tabNaka").className = (tab === 'naka') ? 'tab-active' : 'tab-inactive';
  document.getElementById("tabMori").className = (tab === 'mori') ? 'tab-active' : 'tab-inactive';
  document.getElementById("tabClub").className = (tab === 'club') ? 'tab-active' : 'tab-inactive';
}

/* ===== å…±é€šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ ===== */
function buildCalendarHtml({
  title,
  subtitle,
  year,
  month,
  markFunc,
  moveFunc,
  openFunc,
  legend
}){
  let html = `
  <div class="cookie">
    <h3>${title}</h3>
    <h3>${subtitle}</h3>
    <div class="calendar-nav">
      <button onclick="${moveFunc}(-1)">â—€</button>
      <strong>${year}å¹´ ${month}æœˆ</strong>
      <button onclick="${moveFunc}(1)">â–¶</button>
    </div>
    <div class="calendar-grid">
  `;

  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d=> html+=`<div class="day-name">${d}</div>`);

  const first = new Date(year, month-1, 1);
  for(let i=0;i<first.getDay();i++) html+=`<div></div>`;

  const last = new Date(year, month, 0).getDate();
  for(let d=1; d<=last; d++){
    const info = calendarData.find(x =>
      x.year === year &&
      x.month === month &&
      x.day === d
    );

    const mark = markFunc(info);

    const cellDate = new Date(year, month-1, d);
    const isToday = cellDate.toDateString() === new Date().toDateString();
    const isHoliday = info && info.week && info.week.includes("ç¥");
    const isSun = cellDate.getDay() === 0;
    const isSat = cellDate.getDay() === 6;

    const cls = isToday ? "cal-cell cal-today" :
              (isHoliday || isSun) ? "cal-cell cal-sun" :
              isSat ? "cal-cell cal-sat" :
              "cal-cell";

    html += `
      <div class="${cls}" onclick="${openFunc}(${year}, ${month}, ${d})">
        ${d}
        ${isToday ? `<span class="today-label">æœ¬æ—¥</span>` : ''}
        <div>${mark}</div>
      </div>
    `;
  }

  html += `</div>
    <div class="legend">
      ${legend}
    </div>
  </div>`;

  return html;
}

/* ===== å­¦äº‹è¨˜å·ç”Ÿæˆ ===== */
function parseUniMarks(text){
  if(!text) return [];
  const parts = String(text).split(",").map(s=>s.trim()).filter(Boolean);
  const marks = [];
  parts.forEach(p=>{
    if(/æˆæ¥­æ—¥/.test(p)) marks.push("A");
    if(/ç¥æ—¥æˆæ¥­/.test(p)) marks.push("B");
    if(/ãƒ†ã‚¹ãƒˆ|æœŸæœ«è©¦é¨“/.test(p)) marks.push("C");
    if(/è£œè¬›/.test(p)) marks.push("D");
    if(/æˆä¸å¼|å…¥å­¦å¼/.test(p)) marks.push("å¼å…¸");
    if(/å…¥è©¦/.test(p)) marks.push("E");
    if(!/æˆæ¥­æ—¥|ç¥æ—¥æˆæ¥­|ãƒ†ã‚¹ãƒˆ|æœŸæœ«è©¦é¨“|è£œè¬›|æˆä¸å¼|å…¥å­¦å¼|å…¥è©¦/.test(p)){
      marks.push("â˜…");
    }
  });
  return [...new Set(marks)];
}

function parseCampusMark(text, mark){
  if(!text) return [];
  const parts = String(text).split(",").map(s=>s.trim()).filter(Boolean);
  return parts.length ? [mark] : [];
}

/* ===== ä¸­ç™¾èˆŒé³¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
function renderNakaCalendar(){
  if(!calendarData || !calendarData.length){
    calendar.innerHTML = "<div class='cookie'>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
    return;
  }

  const base = new Date();
  base.setMonth(base.getMonth()+nakaOffset);
  const year = base.getFullYear();
  const month = base.getMonth()+1;

  const html = buildCalendarHtml({
    title: "ä¸­ç™¾èˆŒé³¥ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹æ´»å‹•å¯èƒ½æ—¥æ¦‚è¦",
    subtitle: "ï¼ˆæ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰",
    year,
    month,
    moveFunc: "nakaMove",
    openFunc: "openNakaModal",
    markFunc: (info)=>{
      const status = info ? (info.status||"") : "";
      const uniMarks = parseUniMarks(info ? info.uniText : "");
      const nakaN = parseCampusMark(info ? info.nakaText : "", "N");
      const marks = [];
      if(status) marks.push(status);
      marks.push(...uniMarks);
      marks.push(...nakaN);
      return marks.length ? marks.join("") : "";
    },
    legend: ["ï½è¨˜å·ã®èª¬æ˜ï¼ˆè©³ã—ãã¯æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰ï½",
    "ã€‡=9:00ã€œ21:00 / â—=18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ï¼‰ ",
    " â—‡=9:00ã€œ21:00ï¼ˆãƒ†ã‚¹ãƒˆæœŸé–“ï¼‰ / â—†=18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ãƒ»ãƒ†ã‚¹ãƒˆæœŸé–“ï¼‰",
    " â–³=9:00ã€œ21:00ï¼ˆé™å¯‚ãªæ´»å‹•ã®ã¿å¯ï¼ä¸€éƒ¨æ–½è¨­ä½¿ç”¨ä¸å¯ï¼‰ / â–²=18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ï¼é™å¯‚ãªæ´»å‹•ã®ã¿å¯ï¼‰",
    " Ã—=çµ‚æ—¥ä½¿ç”¨ç¦æ­¢ / ï¼=ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„ / â˜…=å¤§å­¦å…¨ä½“å­¦äº‹äºˆå®šã‚ã‚Š / ?=æœªå®š",
    " A=æˆæ¥­æ—¥ / B=ç¥æ—¥æˆæ¥­ / C=ãƒ†ã‚¹ãƒˆ / D=è£œè¬› / å¼å…¸=æˆä¸å¼ãƒ»å…¥å­¦å¼ / E=å…¥è©¦ / N=ä¸­ç™¾èˆŒé³¥Cå­¦äº‹"].join("<br>")
  });

  calendar.innerHTML = html;
}

function openNakaModal(year, month, day){
  const info = calendarData.find(x =>
    x.year === year && x.month === month && x.day === day
  );

  const mark = info ? info.status : "";
  const timeText = statusText(mark) || "ä¸æ˜";

  const fmt = (title, text) => {
    if(!text) return "";
    return `
      <div class="modal-section">
        <strong>${title}</strong>
        ${text.replace(/\n/g, "<br>")}
      </div>
    `;
  };

  let html = "";

  html += `
    <div class="modal-section">
      <strong>æ´»å‹•å¯èƒ½æ™‚é–“</strong>
      ${timeText}
    </div>
  `;

  const nakaText = info ? (info.nakaText||"") : "";
  const uniText = info ? (info.uniText||"") : "";

  html += `<div class="modal-divider"></div>`;
  html += fmt("ä¸­ç™¾èˆŒé³¥C å­¦äº‹æ—¥ç¨‹", nakaText || "äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“");

  html += `<div class="modal-divider"></div>`;
  html += fmt("å¤§å­¦å…¨ä½“ å­¦äº‹æ—¥ç¨‹", uniText || "äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“");

  modalDate.textContent = `${year}/${month}/${day}ï¼ˆ${info ? info.week : ""}ï¼‰`;
  modalStatus.innerHTML = html;

  document.getElementById("modal").style.display = "flex";
}

function nakaMove(v){
  nakaOffset = Math.min(6, Math.max(-6, nakaOffset + v));
  renderNakaCalendar();
}

/* ===== å¤§å­¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
function renderUniCalendar(){
  if(!calendarData || !calendarData.length){
    uniCalendar.innerHTML = "<div class='cookie'>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
    return;
  }

  const base = new Date();
  base.setMonth(base.getMonth()+uniOffset);
  const year = base.getFullYear();
  const month = base.getMonth()+1;

  const html = buildCalendarHtml({
    title: "å¤§å­¦å…¨ä½“ å­¦äº‹æ—¥ç¨‹",
    subtitle: "ï¼ˆæ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰",
    year,
    month,
    moveFunc: "uniMove",
    openFunc: "openUniModal",
    markFunc: (info)=>{
      const uniMarks = parseUniMarks(info ? info.uniText : "");
      const nakaN = parseCampusMark(info ? info.nakaText : "", "N");
      const sugiS = parseCampusMark(info ? info.sugiText : "", "S");
      const moriM = parseCampusMark(info ? info.moriText : "", "M");
      const marks = [...uniMarks, ...nakaN, ...sugiS, ...moriM];
      return marks.length ? marks.join(",") : "ãƒ¼";
    },
    legend: ["ï½è¨˜å·ã®èª¬æ˜ï¼ˆè©³ã—ãã¯æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰ï½",
    "A=æˆæ¥­æ—¥ / B=ç¥æ—¥æˆæ¥­ / C=ãƒ†ã‚¹ãƒˆ / D=è£œè¬› / å¼å…¸=æˆä¸å¼ãƒ»å…¥å­¦å¼ / E=å…¥è©¦",
    "â˜…=ãã®ä»–ã®å¤§å­¦å…¨ä½“å­¦äº‹ / N=ä¸­ç™¾èˆŒé³¥Cå­¦äº‹ / S=æ‰æœ¬Cå­¦äº‹ / M=æ£®ä¹‹å®®Cå­¦äº‹"].join("<br>")
  });

  uniCalendar.innerHTML = html;
}

function openUniModal(year, month, day){
  const info = calendarData.find(x =>
    x.year === year && x.month === month && x.day === day
  );

  if(!info){
    modalDate.textContent = `${year}/${month}/${day}`;
    modalStatus.textContent = "æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“";
    document.getElementById("modal").style.display = "flex";
    return;
  }

  const block = (label, text) => `
    <div class="modal-section">
      <strong>${label}</strong>
      ${text ? text.replace(/\n/g,"<br>") : "äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“"}
    </div>
  `;

  let html = "";
  html += block("å¤§å­¦å…¨ä½“", info.uniText);
  html += `<div class="modal-divider"></div>`;
  html += block("ä¸­ç™¾èˆŒé³¥C", info.nakaText);
  html += `<div class="modal-divider"></div>`;
  html += block("æ‰æœ¬C", info.sugiText);
  html += `<div class="modal-divider"></div>`;
  html += block("æ£®ä¹‹å®®C", info.moriText);

  modalDate.textContent = `${year}/${month}/${day}ï¼ˆ${info.week || ""}ï¼‰`;
  modalStatus.innerHTML = html;

  document.getElementById("modal").style.display = "flex";
}

function uniMove(v){
  uniOffset = Math.min(6, Math.max(-6, uniOffset + v));
  renderUniCalendar();
}

/* ===== æ£®ä¹‹å®®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
function renderMoriCalendar(){
  if(!calendarData || !calendarData.length){
    moriCalendar.innerHTML = "<div class='cookie'>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
    return;
  }

  const base = new Date();
  base.setMonth(base.getMonth()+moriOffset);
  const year = base.getFullYear();
  const month = base.getMonth()+1;

  const html = buildCalendarHtml({
    title: "æ£®ä¹‹å®®C å­¦äº‹æ—¥ç¨‹",
    subtitle: "ï¼ˆæ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰",
    year,
    month,
    moveFunc: "moriMove",
    openFunc: "openMoriModal",
    markFunc: (info)=>{
      if(!info) return "ãƒ¼";
      const uniMarks = parseUniMarks(info.uniText || "");
      const moriMarks = parseCampusMark(info.moriText || "", "M");
      // N/S ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§é™¤å¤–
      const filtered = [...uniMarks, ...moriMarks].filter(x => x !== "N" && x !== "S");
      return filtered.length ? filtered.join("") : "ãƒ¼";
    },

    legend: ["ï½è¨˜å·ã®èª¬æ˜ï¼ˆè©³ã—ãã¯æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰ï½",
    "A=æˆæ¥­æ—¥ / B=ç¥æ—¥æˆæ¥­ / C=ãƒ†ã‚¹ãƒˆ / D=è£œè¬›æ—¥ / å¼å…¸=æˆä¸å¼ãƒ»å…¥å­¦å¼ / E=å…¥è©¦",
    "â˜…=ãã®ä»–ã®å¤§å­¦å…¨ä½“å­¦äº‹ / M=æ£®ä¹‹å®®Cå­¦äº‹"].join("<br>")
  });

  moriCalendar.innerHTML = html;
}

function openMoriModal(year, month, day){
  const info = calendarData.find(x =>
    x.year === year && x.month === month && x.day === day
  );

  const uniText = info ? info.uniText : "";
  const moriText = info ? info.moriText : "";

  let html = "";

  html += `<div class="modal-section"><strong>å¤§å­¦å…¨ä½“å­¦äº‹æ—¥ç¨‹</strong>${uniText ? uniText.replace(/\n/g,"<br>") : "äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“"}</div>`;
  html += `<div class="modal-divider"></div>`;
  html += `<div class="modal-section"><strong>æ£®ä¹‹å®®Cäºˆå®š</strong>${moriText ? moriText.replace(/\n/g,"<br>") : "äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“"}</div>`;

  modalDate.textContent = `${year}/${month}/${day}ï¼ˆ${info ? info.week : ""}ï¼‰`;
  modalStatus.innerHTML = html;

  document.getElementById("modal").style.display = "flex";
}

function moriMove(v){
  moriOffset = Math.min(6, Math.max(-6, moriOffset + v));
  renderMoriCalendar();
}

/* ===== éƒ¨æ´»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
/* ===== éƒ¨æ´»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
function renderClubCalendar(){
  const base = new Date();
  base.setMonth(base.getMonth() + clubOffset);

  const year = base.getFullYear();
  const month = base.getMonth() + 1;

  const html = buildCalendarHtml({
    title: "éƒ¨æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«",
    subtitle: "ï¼ˆæ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰",
    year,
    month,
    moveFunc: "clubMove",
    openFunc: "openClubModal",
    markFunc: (info)=>{
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®éƒ¨æ´»æƒ…å ±ã‚’å‚ç…§ï¼ˆcalendarData ã§ã¯ãªã clubCalDataï¼‰
      const clubInfo = clubCalData.find(x => x.year === info.year && x.month === info.month && x.day === info.day);

      const clubMark = (clubInfo && clubInfo.clubList && clubInfo.clubList.length > 0) ? ["â—"] : [];
      const uniMarks = parseUniMarks(info ? info.uniText : "");
      const nakaN = parseCampusMark(info ? info.nakaText : "", "N");
      const moriM = parseCampusMark(info ? info.moriText : "", "M");

      const marks = [...clubMark, ...uniMarks, ...nakaN, ...moriM];
      return marks.length ? marks.join(",") : "ãƒ¼";
    },
    legend: [
      "ï½è¨˜å·ã®èª¬æ˜ï¼ˆè©³ã—ãã¯æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰ï½",
      "â—=éƒ¨æ´»äºˆå®šã‚ã‚Š / ãƒ¼=å­¦äº‹ã€éƒ¨æ´»å‹•ã¨ã‚‚ã«äºˆå®šãªã—",
      "A=æˆæ¥­æ—¥ / B=ç¥æ—¥æˆæ¥­ / C=ãƒ†ã‚¹ãƒˆ / D=è£œè¬› / å¼å…¸=å­¦ä½æˆä¸å¼ãƒ»å…¥å­¦å¼ / E=å…¥è©¦ / â˜…=ãã®ä»–ã®å¤§å­¦å…¨ä½“å­¦äº‹",
      "N=ä¸­ç™¾èˆŒé³¥Cã®å­¦äº‹ / M=æ£®ä¹‹å®®Cã®å­¦äº‹"
    ].join("<br>")
  });

  document.getElementById("clubCalendar").innerHTML = html;
}

function openClubModal(year, month, day){
  const infoCal  = calendarData.find(x => x.year === year && x.month === month && x.day === day);
  const infoClub = clubCalData.find(x => x.year === year && x.month === month && x.day === day);

  const uniText  = infoCal ? infoCal.uniText : "";
  const nakaText = infoCal ? infoCal.nakaText : "";
  const moriText = infoCal ? infoCal.moriText : "";
  const nakaStatus = infoCal ? infoCal.status : "";

  const clubList = infoClub ? infoClub.clubList : [];

  if(!uniText &&!nakaText &&!moriText &&!nakaStatus&& (!clubList || clubList.length === 0)){
    modalDate.textContent = `${year}/${month}/${day}`;
    modalStatus.textContent = "ã“ã®æ—¥ã®æ´»å‹•ã¯ã‚ã‚Šã¾ã›ã‚“";
    document.getElementById("modal").style.display = "flex";
    return;
  }

  // ----------------------------
  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š
  // ----------------------------
  let page = 0;
  let pageSize = 5;
  const pageOptions = [1,5,10,20,50,100];

  const getMaxPage = () => Math.max(0, Math.ceil(clubList.length / pageSize) - 1);

  // ----------------------------
  // ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬æ–‡ã‚’ä½œã‚‹é–¢æ•°
  // ----------------------------
  const render = () => {
    let html = "";

    // 2) å¤§å­¦ã®å­¦äº‹æ—¥ç¨‹
    html += `<div class="modal-section"><strong>å¤§å­¦å…¨ä½“å­¦äº‹æ—¥ç¨‹</strong><br>${uniText ? uniText.replace(/\n/g,"<br>") : "å¤§å­¦å…¨ä½“ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“"}</div>`;
    html += `<div class="club-divider">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>`;

    // 3) ä¸­ç™¾èˆŒé³¥C æ´»å‹•å¯èƒ½æ™‚é–“
    html += `<div class="modal-section"><strong>ä¸­ç™¾èˆŒé³¥C æ´»å‹•å¯èƒ½æ™‚é–“</strong><br>${nakaStatus ? statusText(nakaStatus) : "ä¸­ç™¾èˆŒé³¥Cã®æ´»å‹•æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“"}</div>`;
    html += `<div class="club-divider">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>`;

    // 4) ä¸­ç™¾èˆŒé³¥C å­¦äº‹æ—¥ç¨‹
    html += `<div class="modal-section"><strong>ä¸­ç™¾èˆŒé³¥C å­¦äº‹æ—¥ç¨‹</strong><br>${nakaText ? nakaText.replace(/\n/g,"<br>") : "ä¸­ç™¾èˆŒé³¥Cã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“"}</div>`;
    html += `<div class="club-divider">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>`;

    // 5) æ£®ä¹‹å®®C å­¦äº‹æ—¥ç¨‹
    html += `<div class="modal-section"><strong>æ£®ä¹‹å®®C å­¦äº‹æ—¥ç¨‹</strong><br>${moriText ? moriText.replace(/\n/g,"<br>") : "æ£®ä¹‹å®®Cã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“"}</div>`;

    // 6) å¤ªç·š
    html += `<div class="club-divider">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>`;

    // 7) ã‚·ãƒãƒã‚¯ãƒ©ãƒ–ã®æ´»å‹•
    html += `<div class="modal-section"><strong>ã‚·ãƒãƒã‚¯ãƒ©ãƒ–ã®æ´»å‹•</strong></div>`;
    if(clubList.length === 0){
      html += `<div class="modal-section">ã‚·ãƒãƒã‚¯ãƒ©ãƒ–ã®æ´»å‹•ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }
    // 8ã€œ9) ãƒšãƒ¼ã‚¸è¡¨ç¤º + è¡¨ç¤ºä»¶æ•° + å‰ã¸/æ¬¡ã¸ï¼ˆçµ±åˆï¼‰
if(clubList.length > 0){
  const maxPage = getMaxPage();
  const total = clubList.length;

  html += `
    <div class="paging-area">
      <div class="paging-row">
        <span class="paging-info">ãƒšãƒ¼ã‚¸ ${page+1}/${maxPage+1}ï¼ˆåˆè¨ˆ ${total}ä»¶ï¼‰</span>
      </div>

      <div class="paging-row">
        <span class="paging-info">è¡¨ç¤ºä»¶æ•°ï¼š</span>
        <select id="pageSizeSelect">
          ${pageOptions.map(v => `<option value="${v}" ${v===pageSize?'selected':''}>${v}</option>`).join("")}
        </select>

        <button id="prevBtn" class="paging-btn" ${page<=0 ? "disabled" : ""}>â—€ å‰ã¸</button>
        <button id="nextBtn" class="paging-btn" ${page>=maxPage ? "disabled" : ""}>æ¬¡ã¸ â–¶</button>
      </div>
    </div>
  `;
}

    // 10) éƒ¨æ´»å†…å®¹ï¼ˆè¡¨ç¤ºä»¶æ•°ã«å¿œã˜ã‚‹ï¼‰
    if(clubList.length > 0){
      const pageSizeElem = document.getElementById("pageSizeSelect");
      const pageSize = pageSizeElem ? Math.max(1, Number(pageSizeElem.value)) : 5;
      const start = page * pageSize;
      const end = start + pageSize;
      const listToShow = clubList.slice(start, end);

      listToShow.forEach((it, idx) => {
        if(!it.content) return;
        const lines = [];
        // æ´»å‹•å†…å®¹ï¼š
        lines.push(`æ´»å‹•å†…å®¹ï¼š${it.content}`);
        // æ´»å‹•æ™‚é–“ï¼š
        if(it.time) lines.push(`æ´»å‹•æ™‚é–“ï¼š${it.time}`);
        // æ´»å‹•å ´æ‰€ï¼š
        if(it.place) lines.push(`æ´»å‹•å ´æ‰€ï¼š${it.place}`);
        // å¿…è¦äººå“¡ï¼š
        if(it.need) lines.push(`å¿…è¦äººå“¡ï¼š${it.need}`);
        // å‚™è€ƒï¼š
        if(it.note) lines.push(`å‚™è€ƒï¼š${it.note}`);

    html += `
      <div class="club-card">
        <div class="club-card-title"><strong>æ´»å‹•å†…å®¹${start + idx + 1}</strong></div>
        <div class="club-card-body">${lines.join("\n")}</div>
      </div>
    `;
  });
}
    return html;
  };

  // åˆå›è¡¨ç¤º
  modalDate.textContent = `${year}/${month}/${day}`;
  modalStatus.innerHTML = render();
  document.getElementById("modal").style.display = "flex";

  // ----------------------------
  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  // ----------------------------
  const bindEvents = () => {
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageSizeSelect = document.getElementById("pageSizeSelect");

    if(prevBtn){
      prevBtn.addEventListener("click", () => {
        if(page > 0){
          page--;
          modalStatus.innerHTML = render();
          bindEvents();
        }
      });
    }

    if(nextBtn){
      nextBtn.addEventListener("click", () => {
        const maxPage = getMaxPage();
        if(page < maxPage){
          page++;
          modalStatus.innerHTML = render();
          bindEvents();
        }
      });
    }

    if(pageSizeSelect){
      pageSizeSelect.addEventListener("change", (e) => {
        pageSize = Number(e.target.value);
        page = 0; // ãƒšãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ
        modalStatus.innerHTML = render();
        bindEvents();
      });
    }
  };

  bindEvents();
}

function clubMove(v){
  clubOffset = Math.min(6, Math.max(-6, clubOffset + v));
  renderClubCalendar();
}


/* ===== æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š ===== */
function statusText(s){
  if(!s) return "";
  s = String(s).trim();
  s = s.replace(/[â—‹ã€‡]/g, "ã€‡");
  s = s.replace(/[xXâœ•âœ–]/g, "Ã—");
  s = s.replace(/[?ï¼Ÿ]/g, "?");

  const main = s.match(/[ã€‡â—â—‡â—†â–³â–²Ã—]/g) || [];
  const note = s.match(/[!ï¼]/g) || [];

  let mainText = "";
  if(main.includes("ã€‡")) mainText = "9:00ã€œ21:00";
  else if(main.includes("â—")) mainText = "18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ï¼‰";
  else if(main.includes("â—‡")) mainText = "9:00ã€œ21:00ï¼ˆãƒ†ã‚¹ãƒˆæœŸé–“ï¼‰";
  else if(main.includes("â—†")) mainText = "18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ãƒ»ãƒ†ã‚¹ãƒˆæœŸé–“ï¼‰";
  else if(main.includes("â–³")) mainText = "9:00ã€œ21:00ï¼ˆé™å¯‚ãªæ´»å‹•ã®ã¿å¯ï¼ä¸€éƒ¨æ–½è¨­ä½¿ç”¨ä¸å¯ï¼‰";
  else if(main.includes("â–²")) mainText = "18:30ã€œ21:00ï¼ˆéƒ¨å®¤ã¯9:00ã€œ21:00å¯ï¼é™å¯‚ãªæ´»å‹•ã®ã¿å¯ï¼‰";
  else if(main.includes("Ã—")) mainText = "çµ‚æ—¥ä½¿ç”¨ç¦æ­¢";
  else if(main.includes("?")) mainText = "æœªå®š";

  const noteText = note.length ? "â˜…ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„â˜…" : "";
  return [mainText, noteText].filter(x => x).join(" / ");
}



/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function closeModal(){
  document.getElementById("modal").style.display = "none";
  // ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€Œé–‰ã˜ã‚‹ã€ã™ã‚‹ã¨æ¯å›åˆæœŸçŠ¶æ…‹ã«æˆ»ã‚‹
  modalStatus.innerHTML = "";
}

/* ===== è‡ªå‹•åˆ‡æ›¿ ===== */
window.onload = () => {
  load();
  scheduleMidnightReload();

  scheduleMidnightReload();
  runGAS("getButtonData", "A", true).then(renderLinks);
  refreshRoomStatus();
};





 //===== å…¥é€€å®¤å‡¦ç† =====
 function updateRoomUI(status){
  document.getElementById("roomCount").textContent = status.count;

  const enterBtn = document.getElementById("enterBtn");
  const exitBtn  = document.getElementById("exitBtn");

  if(status.myStatus === "in"){
    enterBtn.disabled = true;
    exitBtn.disabled  = false;
  }else{
    enterBtn.disabled = false;
    exitBtn.disabled  = true;
  }
}

function enterRoom(){
  runGAS("enterRoom", visitId).then(refreshRoomStatus);
}

function exitRoom(){
  runGAS("exitRoom", visitId).then(refreshRoomStatus);
}

function refreshRoomStatus(){
  runGAS("getRoomStatus", visitId).then(updateRoomUI);
}

setInterval(refreshRoomStatus, 5 * 60 * 1000);


</script>

</body>
</html>


